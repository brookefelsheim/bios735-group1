---
title: "Notes"
author: "Elena Kharitonova"
date: "4/4/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(MuMIn)
```


What we want to do:
- Remove Solar Radiation 
- Dew Point Temperature
- Visibility 10 m
- Visibility 10 m


- REMOVE ALL DATA POINTS WHERE FUNCTION DAY = NO


Want to add:
- Weekend variable
- Try changing hours to 6 hour blocks and sum bike counts and seeing if that improves (compare using BIC value)
- Try splines
- Temperature change to Max and Min for day
- Humidity change to be consistent with temperature


** Idea make time that is before 4 am be that of last day

Variables in Model:     

* Date (Random Effect)     
* Hour/Time Chunk     
* Max/Min Temp     
* Max/Min Humidity     
* Windspeed     
* Make Rain binary and Snow binary and combine     
* Weekend     
* Seasons      
* Holiday     

# Seoul bike data 

## Data processing 

Load in Seoul bike data
```{r message=FALSE}
seoul <- read_csv("SeoulBikeData.csv")
dim(seoul)
spec(seoul)
```

Non-functioning days have zero bike counts:
```{r}
table(seoul$`Functioning Day`)
any(seoul$`Rented Bike Count`[seoul$`Functioning Day` == "No"] != 0)
```

We assume that this is when the bike system was not operating, so we will remove this from our data.
```{r}
seoul <- seoul %>% 
  filter(`Functioning Day` == "Yes")
```

We want to combine rain and snow into a single binary variable:     
```{r}
seoul <- seoul %>% 
  mutate(`Rain or snow` = ifelse(`Rainfall(mm)` > 0 | `Snowfall (cm)` > 0, 1, 0))
table(seoul$`Rain or snow`)
```

We next want to add a "weekend" variable. We can convert the `Date` column into an R Date object and use the `weekdays()` function to help us do this.     
```{r}
seoul <- seoul %>% 
  mutate(Date = as.Date(Date, format = "%d/%m/%Y")) %>% 
  mutate(Weekend = ifelse(weekdays(Date) == "Saturday" | weekdays(Date) == "Sunday", 1, 0))
table(seoul$Weekend)
```

Format `Holiday` column as 0 and 1 to match other binary variables     
```{r}
seoul <- seoul %>% 
  mutate(Holiday = ifelse(Holiday == "Holiday", 1, 0))
```

Make max or min of temperature for each day
```{r}
temp = seoul %>% group_by(Date) %>% summarise(Min_T = min(`Temperature(C)`), Max_T = max(`Temperature(C)`))
seoul = inner_join(seoul,temp, by = "Date")
```

Make max or min of Humidity for each day
```{r}
hum = seoul %>% group_by(Date) %>% summarise(Min_H = min(`Humidity(%)`), Max_H = max(`Humidity(%)`))
seoul = inner_join(seoul,hum, by = "Date")
```



### Hourly version

```{r}
ggplot(seoul, aes(x = Hour, y = `Rented Bike Count`)) + geom_point(shape = 21)
```

Keep only the columns that will be used as variables in our model:     

* Date (Random Effect)     
* Hour   
* Temp (C)    
* Humidity (%)     
* Windspeed (m/s)    
* Rain or snow 
* Weekend     
* Seasons      
* Holiday     

```{r}
seoul_hourly <- seoul %>% 
  select(`Rented Bike Count`, Date, Hour, Min_T, Max_T, Min_H, Max_H, `Wind speed (m/s)`,
         `Rain or snow`, Weekend, Seasons, Holiday)
```



### Time chunk version

Try Making Time into 8 Hour Chunks
```{r}
seoul$hour_chunks = cut(seoul$Hour, c(0,8,16,24), right = FALSE)

seoul_hourly_chunks <- seoul %>% 
  select(`Rented Bike Count`, Date, hour_chunks, Min_T, Max_T, Min_H, Max_H, `Wind speed (m/s)`,
         `Rain or snow`, Weekend, Seasons, Holiday)


seoul_hourly_chunks = seoul %>% group_by(Date, hour_chunks, Max_T, Min_T, Min_H, Max_H, Seasons, Holiday, Weekend) %>% summarise(`Rented Bike Count` = sum(`Rented Bike Count`), `Wind speed (m/s)` = mean(`Wind speed (m/s)`),`Rain or snow` = if(sum(`Rain or snow`)>0){1} else {0})
```


#### Compare Models
```{r}
hourly = lmer(`Rented Bike Count` ~ factor(Hour) + Min_T + Max_T + Min_H + Max_H + `Wind speed (m/s)` +
         `Rain or snow` + Weekend + Seasons + Holiday + (1|Date), data = seoul_hourly, REML = T)

r.squaredGLMM(hourly)

chunk = lmer(`Rented Bike Count` ~ hour_chunks + Min_T + Max_T + Min_H + Max_H + `Wind speed (m/s)` +
         `Rain or snow` + Weekend + Seasons + Holiday + (1|Date), data = seoul_hourly_chunks, REML = T)

r.squaredGLMM(chunk)


```
So chunks seem to perform better bc larger R^2

# London bike data

```{r}

```


# DC bike data

```{r}

```

